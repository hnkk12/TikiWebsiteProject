<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>Gi·ªè h√†ng</title>
    <link rel="stylesheet" href="stylecart.css" />
    <link rel="icon" type="image/jpg" href="image/logo.png" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css"
    />
    <style>
      body {
        font-family: Arial, sans-serif;
        padding-bottom: 80px;
      }
      h2 {
        text-align: center;
        margin-top: 20px;
      }
      .order-box {
        border: 1px solid #ccc;
        padding: 15px;
        margin: 20px auto;
        width: 350px;
        border-radius: 8px;
        background: #f9f9f9;
      }
      .order-box h3 {
        text-align: center;
        margin-bottom: 15px;
      }
      .order-box label {
        display: block;
        margin-top: 8px;
        font-weight: bold;
      }
      .order-box input,
      .order-box textarea,
      .order-box select {
        width: 100%;
        padding: 6px;
        margin-top: 4px;
        border: 1px solid #ccc;
        border-radius: 4px;
      }
      .qr-box {
        display: none;
        margin-top: 20px;
        text-align: center;
        background: #fff;
        padding: 10px;
        border-radius: 10px;
        border: 1px solid #ddd;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }
      .qr-box img {
        width: 220px;
        border-radius: 8px;
        margin-bottom: 8px;
      }
      .home-btn {
        position: fixed;
        top: 20px;
        left: 20px;
        background: #fff;
        color: #4e54c8;
        padding: 10px 15px;
        border-radius: 8px;
        text-decoration: none;
        font-weight: bold;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        z-index: 1000;
      }
      .home-btn:hover {
        background: #4e54c8;
        color: #fff;
      }
      .cart-item {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
        padding: 8px;
        border-bottom: 1px solid #ddd;
      }
      .cart-details {
        flex: 1;
      }
      .cart-actions {
        text-align: right;
      }
      .cart-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
      }
      #toast {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: #2196f3;
        color: #fff;
        padding: 12px 20px;
        border-radius: 6px;
        display: none;
        z-index: 999;
      }
      #toast.show {
        display: block;
        animation: fadein 0.5s, fadeout 0.5s 2s;
      }
      @keyframes fadein {
        from {
          bottom: 0;
          opacity: 0;
        }
        to {
          bottom: 20px;
          opacity: 1;
        }
      }
      @keyframes fadeout {
        from {
          bottom: 20px;
          opacity: 1;
        }
        to {
          bottom: 0;
          opacity: 0;
        }
      }
      .coupon-section {
        border: 1px solid #ccc;
        padding: 15px;
        margin: 20px auto;
        width: 350px;
        border-radius: 8px;
        background: #f0f0f0;
        text-align: left;
      }
    </style>
  </head>
  <body>
    <h2>Gi·ªè h√†ng c·ªßa b·∫°n</h2>

    <a href="index.php" class="home-btn"> Trang ch·ªß</a>

    <div
      style="
        position: fixed;
        top: 20px;
        right: 20px;
        display: flex;
        gap: 10px;
        align-items: center;
      "
    >
      <img
        src="https://cdn-icons-png.flaticon.com/128/7368/7368459.png"
        alt="Tra c·ª©u"
        id="toggleSearch"
        style="width: 32px; height: 32px; cursor: pointer"
      />

      <div id="searchBox" style="display: none; gap: 10px; align-items: center">
        <input
          type="text"
          id="trackCode"
          placeholder="Nh·∫≠p m√£ ƒë∆°n h√†ng..."
          style="padding: 6px; border-radius: 6px; border: 1px solid #ccc"
        />
        <button
          id="trackBtn"
          style="
            padding: 6px 10px;
            border-radius: 6px;
            border: none;
            background: #4e54c8;
            color: #fff;
            cursor: pointer;
          "
        >
          Tra c·ª©u
        </button>
      </div>
    </div>

    <div class="cart-header">
      <input type="checkbox" id="selectAll" />
      <label for="selectAll">Ch·ªçn t·∫•t c·∫£</label>
    </div>

    <div id="cart-container"></div>
    <h3 id="total"></h3>

    <div class="order-box">
      <h3>Th√¥ng tin kh√°ch h√†ng</h3>
      <label for="fullname">H·ªç v√† T√™n:</label>
      <input type="text" id="fullname" placeholder="Nh·∫≠p h·ªç t√™n..." />
      <label for="phone">S·ªë ƒëi·ªán tho·∫°i:</label>
      <input type="text" id="phone" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i..." />
      <label for="email">Email:</label>
      <input type="email" id="email" placeholder="Nh·∫≠p email..." />
      <label for="address">ƒê·ªãa ch·ªâ:</label>
      <textarea id="address" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ..." rows="3"></textarea>
      <label for="payment">Ph∆∞∆°ng th·ª©c thanh to√°n:</label>
      <select id="payment">
        <option value="cod">Thanh to√°n khi nh·∫≠n h√†ng (COD)</option>
        <option value="bank">Chuy·ªÉn kho·∫£n ng√¢n h√†ng</option>
      </select>
      <div class="qr-box" id="qrBox">
        <img src="image/qr-bank.jpg" alt="QR Bank" />
        <p>
          N·ªôi dung: Thanh to√°n ƒë∆°n h√†ng<br />S·ªë ti·ªÅn:
          <span id="qrAmount">0</span>‚Ç´
        </p>
      </div>
    </div>

    <div class="coupon-section">
      <h3>üéü M√£ gi·∫£m gi√°</h3>
      <div class="coupon-box">
        <select id="coupon">
          <option value="0">-- Kh√¥ng √°p d·ª•ng --</option>
          <option value="10">GIAM10 - Gi·∫£m 10%</option>
          <option value="20">GIAM20 - Gi·∫£m 20%</option>
          <option value="50">GIAM50 - Gi·∫£m 50%</option>
          <option value="70">GIAM70 - Gi·∫£m 70%</option>
        </select>
        <button id="applyCoupon">√Åp d·ª•ng</button>
      </div>
      <p id="coupon-message"></p>
    </div>

    <button id="checkout">Thanh to√°n</button>
    <div id="toast"></div>

    <script>
      let cart = JSON.parse(localStorage.getItem("cart")) || [];
      let container = document.getElementById("cart-container");
      let totalEl = document.getElementById("total");
      let paymentSelect = document.getElementById("payment");
      let qrBox = document.getElementById("qrBox");
      let qrAmount = document.getElementById("qrAmount");
      let orderTotal = 0;

      let appliedDiscount = 0;
      let isFixed = false;

      const couponSelect = document.getElementById("coupon");
      const couponMsg = document.getElementById("coupon-message");
      const applyBtn = document.getElementById("applyCoupon");

      applyBtn.addEventListener("click", () => {
        const val = couponSelect.value;
        if (val.endsWith("k")) {
          appliedDiscount = parseInt(val);
          isFixed = true;
          couponMsg.innerText = `ƒê√£ √°p d·ª•ng m√£ gi·∫£m gi√° ${appliedDiscount.toLocaleString()}‚Ç´`;
        } else {
          appliedDiscount = parseInt(val);
          isFixed = false;
          if (appliedDiscount > 0)
            couponMsg.innerText = `ƒê√£ √°p d·ª•ng m√£ gi·∫£m gi√° ${appliedDiscount}%`;
          else couponMsg.innerText = "";
        }
        renderCart();
      });

      function showToast(msg, type = "info") {
        const toast = document.getElementById("toast");
        toast.innerHTML = msg.replace(/\n/g, "<br>");
        toast.className = "show";
        toast.style.background =
          type === "success"
            ? "#4caf50"
            : type === "error"
            ? "#f44336"
            : "#2196f3";
        setTimeout(() => {
          toast.className = toast.className.replace("show", "");
        }, 2500);
      }

      function renderCart() {
        container.innerHTML = "";
        let total = 0;

        if (cart.length === 0) {
          container.innerHTML = "<p>Gi·ªè h√†ng tr·ªëng.</p>";
          totalEl.innerText = "";
          qrAmount.innerText = "0";

          // ·∫®n "ch·ªçn t·∫•t c·∫£" khi kh√¥ng c√≥ s·∫£n ph·∫©m
          document.querySelector(".cart-header").style.display = "none";
          return;
        }
        //ƒë√≥ng m·ªü t√¨m ki·∫øm
        document
          .getElementById("toggleSearch")
          .addEventListener("click", () => {
            const box = document.getElementById("searchBox");
            box.style.display = box.style.display === "none" ? "flex" : "none";
          });

        // Hi·ªán "ch·ªçn t·∫•t c·∫£" n·∫øu c√≥ t·ª´ 2 s·∫£n ph·∫©m
        if (cart.length >= 2) {
          document.querySelector(".cart-header").style.display = "flex";
        } else {
          document.querySelector(".cart-header").style.display = "none";
        }

        cart.forEach((item, i) => {
          if (item.selected === undefined) item.selected = true;
          let priceNum = parseInt(item.price.replace(/[^\d]/g, ""));
          if (item.selected) total += priceNum * item.quantity;

          let div = document.createElement("div");
          div.classList.add("cart-item");
          div.innerHTML = `
          <input type="checkbox" ${item.selected ? "checked" : ""}
            onchange="toggleSelect(${i},this.checked)" />
          <img src="${item.image}" alt="${item.name}" width="60">
          <div class="cart-details"><b>${item.name}</b><br>${item.price}</div>
          <div class="cart-actions">
            <button onclick="changeQuantity(${i},-1)">-</button>
            <span>${item.quantity}</span>
            <button onclick="changeQuantity(${i},1)">+</button>
            <button onclick="removeItem(${i})">X√≥a</button>
          </div>
        `;
          container.appendChild(div);
        });

        let totalToPay = total;
        let discountAmount = 0;

        if (appliedDiscount > 0) {
          if (isFixed) discountAmount = appliedDiscount;
          else discountAmount = Math.round((total * appliedDiscount) / 100);

          totalToPay = total - discountAmount;
          if (totalToPay < 0) totalToPay = 0;

          totalEl.innerHTML = `
        Gi√° g·ªëc: ${total.toLocaleString("vi-VN")}‚Ç´<br>
        Gi·∫£m: ${discountAmount.toLocaleString("vi-VN")}‚Ç´<br>
        T·ªïng: ${totalToPay.toLocaleString("vi-VN")}‚Ç´
      `;
        } else {
          totalEl.innerText =
            "T·ªïng: " + totalToPay.toLocaleString("vi-VN") + "‚Ç´";
        }

        qrAmount.innerText = totalToPay.toLocaleString("vi-VN");

        document.getElementById("selectAll").checked = cart.every(
          (i) => i.selected
        );
      }

      function toggleSelect(i, checked) {
        cart[i].selected = checked;
        localStorage.setItem("cart", JSON.stringify(cart));
        renderCart();
      }
      function changeQuantity(i, delta) {
        if (!cart[i]) return;
        cart[i].quantity += delta;
        if (cart[i].quantity <= 0) {
          cart.splice(i, 1);
          showToast("ƒê√£ x√≥a s·∫£n ph·∫©m kh·ªèi gi·ªè h√†ng", "error");
        } else showToast("C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng: " + cart[i].quantity, "info");
        localStorage.setItem("cart", JSON.stringify(cart));
        renderCart();
      }
      function removeItem(i) {
        cart.splice(i, 1);
        localStorage.setItem("cart", JSON.stringify(cart));
        renderCart();
        showToast("S·∫£n ph·∫©m ƒë√£ b·ªã x√≥a!", "error");
      }

      document
        .getElementById("selectAll")
        .addEventListener("change", function () {
          cart.forEach((i) => (i.selected = this.checked));
          localStorage.setItem("cart", JSON.stringify(cart));
          renderCart();
        });

      paymentSelect.addEventListener("change", () => {
        qrBox.style.display = paymentSelect.value === "bank" ? "block" : "none";
      });

      document.getElementById("checkout").addEventListener("click", () => {
        const selectedItems = cart.filter((i) => i.selected);
        if (selectedItems.length === 0) {
          showToast("Ch∆∞a ch·ªçn s·∫£n ph·∫©m n√†o ƒë·ªÉ thanh to√°n!", "error");
          return;
        }

        const name = document.getElementById("fullname").value.trim();
        const phone = document.getElementById("phone").value.trim();
        const email = document.getElementById("email").value.trim();
        const address = document.getElementById("address").value.trim();
        const payment = paymentSelect.value;

        if (!name || !phone || !address) {
          showToast("Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!", "error");
          return;
        }

        let total = 0;
        selectedItems.forEach((item) => {
          total += parseInt(item.price.replace(/[^\d]/g, "")) * item.quantity;
        });

        // √Åp d·ª•ng voucher
        let finalTotal = total;
        if (appliedDiscount > 0) {
          if (isFixed) finalTotal -= appliedDiscount;
          else finalTotal -= Math.round((finalTotal * appliedDiscount) / 100);
        }
        if (finalTotal < 0) finalTotal = 0;

        fetch("save_order.php", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            name,
            phone,
            email,
            address,
            cart: selectedItems,
            total: finalTotal,
            payment,
          }),
        })
          .then((res) => res.json())
          .then((data) => {
            if (data.status === "success") {
              showToast(
                `ƒê·∫∑t h√†ng th√†nh c√¥ng! M√£ ƒë∆°n h√†ng: ${data.order_code}`,
                "success"
              );
              localStorage.removeItem("cart");
              cart = [];
              renderCart();
            } else showToast("C√≥ l·ªói khi l∆∞u ƒë∆°n h√†ng!", "error");
          })
          .catch((err) => {
            console.error(err);
            showToast("L·ªói k·∫øt n·ªëi server!", "error");
          });
      });

      // Tra c·ª©u ƒë∆°n h√†ng
      document.getElementById("trackBtn").addEventListener("click", () => {
        const code = document.getElementById("trackCode").value.trim();
        if (!code) {
          showToast("Vui l√≤ng nh·∫≠p m√£ ƒë∆°n h√†ng!", "error");
          return;
        }

        fetch("track_order.php", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ order_code: code }),
        })
          .then((res) => res.json())
          .then((data) => {
            if (data.status === "success") {
              const status = data.order.status || "ƒêang x·ª≠ l√Ω";

              // Danh s√°ch s·∫£n ph·∫©m tr∆∞·ªõc
              let products = "S·∫£n ph·∫©m:\n";
              data.items.forEach((it) => {
                products += `- ${it.product_name} x ${it.quantity} - ${parseInt(
                  it.price
                ).toLocaleString("vi-VN")}‚Ç´\n`;
              });

              // Sau ƒë√≥ tr·∫°ng th√°i + t·ªïng
              const info = `${products}
Tr·∫°ng th√°i: ${status}
T·ªïng: ${parseInt(data.order.total_price).toLocaleString("vi-VN")}‚Ç´
`;

              showToast(info, "success");
            } else {
              // N·∫øu kh√¥ng c√≥ ƒë∆°n h√†ng
              const info = `B·∫°n ch∆∞a c√≥ ƒë∆°n h√†ng n√†o trong h·ªá th·ªëng.`;
              showToast(info, "info");
            }
          })

          .catch((err) => {
            console.error(err);
            showToast("L·ªói k·∫øt n·ªëi server!", "error");
          });
      });

      renderCart();
    </script>
  </body>
</html>
